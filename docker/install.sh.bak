#!/bin/bash
# FilePath    : blog-tool/docker/install.sh
# Author      : jiaopengzi
# Blog        : https://jiaopengzi.com
# Copyright   : Copyright (c) 2025 by jiaopengzi, All Rights Reserved.
# Description : å®‰è£…docker

# DEFAULT_DOWNLOAD_URL="https://download.docker.com" # å®˜æ–¹æº
# DEFAULT_HUB_URL="https://hub.docker.com"           # å®˜æ–¹ Docker Hub
# DOCKER_CE_TEST_DOWNLOAD_FILE="linux/debian/gpg"    # æµ‹è¯•æ–‡ä»¶è·¯å¾„(ç›¸å¯¹äºé•œåƒæºæ ¹ç›®å½•)

# # Docker CE é•œåƒæºåˆ—è¡¨
# DOCKER_CE_SOURCES=(
#     "https://mirrors.aliyun.com/docker-ce"           # é˜¿é‡Œäº‘
#     "https://mirrors.tencent.com/docker-ce"          # è…¾è®¯äº‘
#     "https://mirrors.163.com/docker-ce"              # ç½‘æ˜“äº‘
#     "https://mirrors.cernet.edu.cn/docker-ce"        # ä¸­å›½æ•™è‚²ç½‘
#     "https://mirrors.tuna.tsinghua.edu.cn/docker-ce" # æ¸…åå¤§å­¦
#     "https://mirrors.huaweicloud.com/docker-ce"      # åä¸ºäº‘
#     "https://mirrors.cmecloud.cn/docker-ce"          # ä¸­å›½ç§»åŠ¨äº‘
#     "https://mirrors.volces.com/docker"              # ç«å±±å¼•æ“
#     "https://mirror.azure.cn/docker-ce"              # Azure ä¸­å›½
#     "https://mirrors.pku.edu.cn/docker-ce"           # åŒ—äº¬å¤§å­¦
#     "https://mirrors.zju.edu.cn/docker-ce"           # æµ™æ±Ÿå¤§å­¦
#     "https://mirrors.nju.edu.cn/docker-ce"           # å—äº¬å¤§å­¦
#     "https://mirror.sjtu.edu.cn/docker-ce"           # ä¸Šæµ·äº¤é€šå¤§å­¦
#     "https://mirrors.cqupt.edu.cn/docker-ce"         # é‡åº†é‚®ç”µå¤§å­¦
#     "https://mirrors.ustc.edu.cn/docker-ce"          # ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦
#     "https://mirror.iscas.ac.cn/docker-ce"           # ä¸­å›½ç§‘å­¦é™¢
#     "https://download.docker.com"                    # å®˜æ–¹æº
# )

# # å®‰è£… docker åˆ°å®¿ä¸»æœº
# install_docker_bak() {
#     # å¯åŠ¨ä»£ç†æœåŠ¡
#     if [ -f "$PROXY_SERVICE" ]; then
#         sudo systemctl start xray-core-proxy.service # ä½¿ç”¨ä»£ç†æ›´æ–°æº
#     fi

#     # å¸è½½æ—§ç‰ˆæœ¬
#     # å‚è€ƒï¼šhttps://docs.docker.com/engine/install/debian/
#     for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do sudo apt remove $pkg; done

#     # Add Docker's official GPG key:
#     apt_update

#     sudo apt install -y ca-certificates curl
#     sudo install -m 0755 -d /etc/apt/keyrings

#     if [ -f "$PROXY_SERVICE" ]; then
#         # ä½¿ç”¨ä»£ç†
#         sudo -E curl -x "$PROXY_LOCAL_URL" -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
#         # sudo -E curl -x "$PROXY_LOCAL_URL" -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
#     else
#         sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
#         # sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
#     fi

#     sudo chmod a+r /etc/apt/keyrings/docker.asc

#     # Add the repository to Apt sources:
#     # shellcheck disable=SC1091
#     # debian
#     echo \
#         "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
#   $(. /etc/os-release && echo "$VERSION_CODENAME") stable" |
#         sudo tee /etc/apt/sources.list.d/docker.list >/dev/null

#     # # shellcheck disable=SC1091
#     # # ubuntu
#     # echo \
#     #   "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
#     # $(. /etc/os-release && echo "$VERSION_CODENAME") stable" |
#     #   sudo tee /etc/apt/sources.list.d/docker.list >/dev/null

#     apt_update

#     # å®‰è£… docker
#     apt_install_y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

#     # å¯åŠ¨ docker
#     sudo systemctl start docker

#     # è®¾ç½® docker å¼€æœºå¯åŠ¨
#     sudo systemctl enable docker

#     # æŸ¥çœ‹ docker æ˜¯å¦å¼€æœºå¯åŠ¨
#     sudo systemctl is-enabled docker

#     # æ ¡éªŒ docker æ˜¯å¦å®‰è£…æˆåŠŸ
#     # sudo docker run hello-world

#     # åœæ­¢ä»£ç†æœåŠ¡
#     if [ -f "$PROXY_SERVICE" ]; then
#         sudo systemctl stop xray-core-proxy.service # ä½¿ç”¨ä»£ç†æ›´æ–°æº
#     fi

#     # æŸ¥çœ‹ docker ç‰ˆæœ¬
#     # å¦‚æœ docker æ²¡æœ‰è¿”å›ç‰ˆæœ¬å·åˆ™å®‰è£…å¤±è´¥
#     if ! sudo docker --version; then
#         log_error "dockerå®‰è£…å¤±è´¥"
#         exit 1
#     fi

#     log_info "dockerå®‰è£…å®Œæˆ"
# }

# # æµ‹è¯•å¹¶æ‰¾å‡ºæœ€å¿«çš„ Docker CE é•œåƒæº
# find_fastest_docker_mirror() {
#     declare -A results   # ç”¨äºå­˜å‚¨æ¯ä¸ªæºçš„ä¸‹è½½æ—¶é—´çš„å…³è”æ•°ç»„
#     fastest_source=""    # æœ€å¿«çš„æº
#     fastest_time=9999999 # æœ€å¿«çš„æ—¶é—´, åˆå§‹ä¸ºä¸€ä¸ªå¾ˆå¤§çš„æ•°å€¼, é¿å…æœªèµ‹å€¼æ¯”è¾ƒ

#     # å¾ªç¯æµ‹è¯•æ¯ä¸ªé•œåƒæº
#     for mirror in "${DOCKER_CE_SOURCES[@]}"; do
#         # æ‹¼æ¥å®Œæ•´çš„æµ‹è¯• URL
#         test_url="${mirror}/${DOCKER_CE_TEST_DOWNLOAD_FILE}"

#         # ä½¿ç”¨ curl æµ‹è¯•ä¸‹è½½æ—¶é—´(ä¸ä¿å­˜æ–‡ä»¶,åªè¿”å›æ€»è€—æ—¶, å•ä½ç§’)
#         # -s: silent, -o /dev/null: ä¸è¾“å‡ºåˆ°æ–‡ä»¶, -w '%{time_total}': è¾“å‡ºæ€»æ—¶é—´
#         download_time=$(curl -s -o /dev/null -w '%{time_total}' "$test_url" 2>/dev/null || echo 9999)

#         # åˆ¤æ–­æ˜¯å¦è¶…æ—¶æˆ–å¤±è´¥(å¦‚è¿”å›äº†é»˜è®¤çš„ 9999 æˆ–å¤§äº 10 ç§’å¯èƒ½ä¸ºæ— æ•ˆæº)
#         if [[ $(echo "$download_time >= 10" | bc) -eq 1 ]] || [[ "$download_time" == "9999" ]]; then
#             # log_error "æµ‹è¯•æº $mirror å¤±è´¥æˆ–è¶…æ—¶"
#             results["$mirror"]="å¤±è´¥æˆ–è¶…æ—¶"
#         else
#             # log_info "æµ‹è¯•æº $mirror æˆåŠŸ, è€—æ—¶ ${download_time} ç§’"
#             results["$mirror"]="$download_time"

#             # åˆ¤æ–­æ˜¯å¦ä¸ºç›®å‰æœ€å¿«çš„
#             if (($(echo "$download_time < $fastest_time" | bc -l))); then
#                 fastest_time="$download_time"
#                 fastest_source="$mirror"
#             fi
#         fi
#     done

#     log_debug "æµ‹è¯•å®Œæˆ, ç»“æœå¦‚ä¸‹ï¼š"

#     # è¾“å‡ºæ‰€æœ‰æºçš„ç»“æœ
#     for mirror in "${DOCKER_CE_SOURCES[@]}"; do
#         time=${results["$mirror"]}
#         if [[ "$time" == "å¤±è´¥æˆ–è¶…æ—¶" ]]; then
#             log_debug "æµ‹è¯•æº $mirror å¤±è´¥æˆ–è¶…æ—¶"
#         else
#             # ä½¿ç”¨ printf -v å°†æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²å†™å…¥å˜é‡, ç„¶åé€šè¿‡ log_info è¾“å‡º
#             printf -v formatted_msg "  ğŸŸ© %s : %.3f ç§’" "$mirror" "$time"
#             log_debug "$formatted_msg"
#         fi
#     done

#     # è¾“å‡ºæœ€å¿«çš„æº
#     if [[ -n "$fastest_source" ]]; then
#         log_debug "ğŸ† æœ€å¿«çš„ Docker CE é•œåƒæºæ˜¯ï¼š$fastest_source (è€—æ—¶ ${fastest_time} ç§’)"
#     else
#         log_error "æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„é•œåƒæº"
#     fi

#     echo "$fastest_source"
# }

# ====================== ä¸Šè¿°ä¸ºåŸæ¥ä»£ç ç•™å­˜åç»­ä½¿ç”¨ ======================

# è®¾ç½® docker daemon é…ç½®
set_daemon_config() {
    log_debug "run set_daemon_config"

    # æ£€æŸ¥ /etc/docker/daemon.json æ–‡ä»¶æ˜¯å¦å­˜åœ¨, å¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºå®ƒ
    if [ ! -f "/etc/docker/daemon.json" ]; then
        sudo mkdir -p /etc/docker
        echo '{}' | sudo tee /etc/docker/daemon.json >/dev/null
    else
        # å¤‡ä»½åŸæ–‡ä»¶, åŠ ä¸Šæ—¶é—´æˆ³é˜²æ­¢è¦†ç›–
        sudo cp /etc/docker/daemon.json "/etc/docker/daemon.json.bak.$(date +%Y%m%d%H%M%S)"
    fi

    # ä½¿ç”¨ jq è®¾ç½®æ—¥å¿—é…ç½®
    # live-restore: å¯ç”¨åå³ä½¿ docker å®ˆæŠ¤è¿›ç¨‹åœæ­¢, å®¹å™¨ä¹Ÿä¼šç»§ç»­è¿è¡Œ
    # ä½¿ç”¨ json-file æ—¥å¿—é©±åŠ¨, é™åˆ¶æ—¥å¿—æ–‡ä»¶å¤§å°ä¸º 100MB, ä¿ç•™ 7 ä¸ªè½®è½¬æ–‡ä»¶, å¹¶æ·»åŠ  production æ ‡ç­¾
    sudo jq '
    .["live-restore"] = true |
    .["log-driver"] = "json-file" |
    .["log-opts"]["max-size"] = "100m" |
    .["log-opts"]["max-file"] = "7" |
    .["log-opts"]["labels"] = "production"' /etc/docker/daemon.json | sudo tee /etc/docker/daemon.json.tmp >/dev/null

    # éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•æ˜¯å¦æ­£ç¡®; åˆ¤æ–­å›æ˜¾æ˜¯å¦åŒ…å« "configuration OK" å†…å®¹
    if sudo dockerd --validate --config-file /etc/docker/daemon.json.tmp 2>&1 | grep -q "configuration OK"; then
        log_info "docker æ—¥å¿—é…ç½®è¯­æ³•éªŒè¯é€šè¿‡"
    else
        log_error "docker æ—¥å¿—é…ç½®è¯­æ³•éªŒè¯å¤±è´¥, è¯·æ£€æŸ¥ /etc/docker/daemon.json.tmp æ–‡ä»¶"
        sudo rm -f /etc/docker/daemon.json.tmp
        return 1
    fi

    sudo mv /etc/docker/daemon.json.tmp /etc/docker/daemon.json

    # é‡å¯ docker æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ
    log_info "docker æ­£åœ¨é‡å¯..."
    sudo systemctl restart docker

    log_info "docker daemon é…ç½®è®¾ç½®å®Œæˆ, è¯·æŸ¥çœ‹ /etc/docker/daemon.json æ–‡ä»¶"
}

# æ‰§è¡Œ docker å®‰è£…å’Œé…ç½®
__install_docker() {
    log_debug "run __install_docker"

    # è„šæœ¬ä¸‹è½½åœ°å€æ ¹æ®ç½‘ç»œç¯å¢ƒé€‰æ‹©
    local script_url
    if [[ $(curl -s ipinfo.io/country) == "CN" ]]; then
        log_debug "æ£€æµ‹åˆ°å›½å†…ç½‘ç»œç¯å¢ƒ, ä½¿ç”¨å›½å†…æºå®‰è£… docker"
        log_info "**ç‰¹åˆ«é¸£è°¢ https://linuxmirrors.cn æä¾›çš„ Docker å®‰è£…è„šæœ¬**"
        script_url="https://linuxmirrors.cn/docker.sh"
    else
        log_debug "æ£€æµ‹åˆ°éå›½å†…ç½‘ç»œç¯å¢ƒ, ä½¿ç”¨å®˜æ–¹æºå®‰è£… docker"
        script_url="https://get.docker.com"
    fi

    local script_file="./install-docker.sh"

    # ä¸‹è½½è„šæœ¬
    if ! sudo curl -fsSL --retry 2 --retry-delay 3 --connect-timeout 5 --max-time 10 "$script_url" -o "$script_file"; then
        log_debug "ä¸‹è½½å‘½ä»¤: sudo curl -fsSL --retry 2 --retry-delay 3 --connect-timeout 5 --max-time 10 $script_url -o $script_file"
        log_error "ä¸‹è½½Dockerå®‰è£…è„šæœ¬å¤±è´¥"
        return 1
    fi

    # ç»™è„šæœ¬æ‰§è¡Œæƒé™
    sudo chmod +x "$script_file"

    # ç›´æ¥æ‰§è¡Œè„šæœ¬ï¼Œè€Œä¸æ˜¯ç”¨source
    if sudo bash "$script_file" 2>&1 | tee -a ./install.log; then
        log_info "docker å®‰è£…å®Œæˆ"

        # è®¾ç½® docker æ—¥å¿—é…ç½®
        set_daemon_config
    else
        log_error "docker å®‰è£…å¤±è´¥"
        return 1
    fi

    # ç§»é™¤å®‰è£…è„šæœ¬
    sudo rm -f "$script_file"
}

# å¸è½½ docker
__uninstall_docker() {
    log_debug "run __uninstall_docker"

    # åœæ­¢æœåŠ¡
    sudo systemctl stop docker || true

    # å¸è½½ docker
    sudo apt purge -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin docker-ce-rootless-extras || true

    # è‡ªåŠ¨åˆ é™¤æ— ç”¨ä¾èµ–
    sudo apt autoremove -y

    log_info "docker å¸è½½å®Œæˆ"

    is_remove=$(read_user_input "æ˜¯å¦éœ€è¦ç§»é™¤ docker çš„å†å²æ•°æ® docker (é»˜è®¤n) [y|n]? " "n")

    if [[ "$is_remove" == "y" ]]; then
        # åˆ é™¤ç›¸å…³æ•°æ®
        sudo rm -rf /var/lib/docker
        sudo rm -rf /var/lib/containerd

        # åˆ é™¤ apt æºå’Œ keyring
        sudo rm /etc/apt/sources.list.d/docker.list
        sudo rm /etc/apt/keyrings/docker.asc

        log_info "å·²ç§»é™¤ docker å†å²æ•°æ®"
    else
        log_info "æœªç§»é™¤ docker å†å²æ•°æ®"
    fi
}

# å¸è½½ docker
uninstall_docker() {
    log_debug "run uninstall_docker"

    is_uninstall=$(read_user_input "æ˜¯å¦å¸è½½ docker (é»˜è®¤n) [y|n]? " "n")
    if [[ "$is_uninstall" == "y" ]]; then
        __uninstall_docker
    else
        log_info "æœªå¸è½½ docker"
    fi
}

# docker å®‰è£…å…¥å£å‡½æ•°
install_docker() {
    log_debug "run install_docker"

    # åˆ¤æ–­æ˜¯å¦å®‰è£…äº† docker
    if command -v docker >/dev/null 2>&1; then
        log_warn "æ£€æµ‹åˆ°å·²å®‰è£… Docker"

        local is_install
        is_install=$(read_user_input "æ˜¯å¦éœ€è¦å¸è½½åé‡æ–°å®‰è£… docker (é»˜è®¤n) [y|n]? " "n")

        if [[ "$is_install" == "y" ]]; then
            log_debug "å¼€å§‹å¸è½½ docker"

            # å¸è½½ docker
            __uninstall_docker

            # æ‰§è¡Œå®‰è£…
            __install_docker
        else
            log_info "è·³è¿‡ docker é‡æ–°å®‰è£…æ­¥éª¤"
            return
        fi
    else
        # æ‰§è¡Œå®‰è£…
        __install_docker
    fi
}
